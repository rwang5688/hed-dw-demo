AWSTemplateFormatVersion: 2010-09-09

Resources:
  HEDDWDemoS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: TRUE
        BlockPublicPolicy: TRUE
        IgnorePublicAcls: TRUE
        RestrictPublicBuckets: TRUE
      VersioningConfiguration:
        Status: Suspended

  HEDDWDemoS3BucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref HEDDWDemoS3Bucket
      PolicyDocument:
        Id: HEDDWDemoS3BucketPolicy
        Version: 2012-10-17
        Statement:
          - Sid: AllowOnlySecureTransport
            Action:
              - s3:*
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal: '*'
            Resource:
              - !Sub 'arn:aws:s3:::${HEDDWDemoS3Bucket}'
              - !Sub 'arn:aws:s3:::${HEDDWDemoS3Bucket}/*'

  HEDDWDemoS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: HEDDWDemoS3Policy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
            Resource:
              - !Sub ${HEDDWDemoS3Bucket.Arn}/*
          -
            Effect: Allow
            Action:
              - s3:ListBucket
            Resource:
              - !GetAtt HEDDWDemoS3Bucket.Arn
      Roles:
        - !Ref GlueLabRole

  GlueLabRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - glue.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /service-role/
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
        - arn:aws:iam::aws:policy/AmazonKinesisFullAccess

  LakeFormationWorkflowRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - glue.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        -
          PolicyName: DatalakeDataAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              -
                Sid: Lakeformation
                Effect: Allow
                Action:
                  - lakeformation:GetDataAccess
                  - lakeformation:GrantPermissions
                Resource: "*"
        -
          PolicyName: DatalakePassRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              -
                Sid: PassRolePermissions
                Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
        - arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess

  WorkgroupAS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: TRUE
        BlockPublicPolicy: TRUE
        IgnorePublicAcls: TRUE
        RestrictPublicBuckets: TRUE
      VersioningConfiguration:
        Status: Suspended

  WorkgroupAS3BucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref WorkgroupAS3Bucket
      PolicyDocument:
        Id: WorkgroupAS3BucketPolicy
        Version: 2012-10-17
        Statement:
          - Sid: AllowOnlySecureTransport
            Action:
              - s3:*
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal: '*'
            Resource:
              - !Sub 'arn:aws:s3:::${WorkgroupAS3Bucket}'
              - !Sub 'arn:aws:s3:::${WorkgroupAS3Bucket}/*'

  WorkgroupBS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: TRUE
        BlockPublicPolicy: TRUE
        IgnorePublicAcls: TRUE
        RestrictPublicBuckets: TRUE
      VersioningConfiguration:
        Status: Suspended

  WorkgroupBS3BucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref WorkgroupBS3Bucket
      PolicyDocument:
        Id: WorkgroupBS3BucketPolicy
        Version: 2012-10-17
        Statement:
          - Sid: AllowOnlySecureTransport
            Action:
              - s3:*
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal: '*'
            Resource:
              - !Sub 'arn:aws:s3:::${WorkgroupBS3Bucket}'
              - !Sub 'arn:aws:s3:::${WorkgroupBS3Bucket}/*'

  BusinessAnalystUserPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for providing required access to the business analyst user
      Path: /
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action: athena:ListWorkGroups
            Resource: "*"
          -
            Effect: Allow
            Action:
              - s3:ListBucketMultipartUploads
              - athena:StartQueryExecution
              - athena:GetQueryResultsStream
              - athena:GetQueryResults
              - s3:CreateBucket
              - s3:ListBucket
              - athena:DeleteNamedQuery
              - athena:GetNamedQuery
              - athena:ListTagsForResource
              - athena:ListQueryExecutions
              - s3:ListMultipartUploadParts
              - athena:ListNamedQueries
              - s3:PutObject
              - s3:GetObject
              - s3:GetObjectAcl
              - athena:GetWorkGroup
              - athena:CreateNamedQuery
              - s3:AbortMultipartUpload
              - athena:StopQueryExecution
              - athena:GetQueryExecution
              - athena:BatchGetNamedQuery
              - s3:GetBucketLocation
              - athena:BatchGetQueryExecution
            Resource:
              - !Sub arn:aws:s3:::${WorkgroupAS3Bucket}/*
              - !Sub arn:aws:s3:::${WorkgroupAS3Bucket}
              - !Sub arn:aws:s3:::${HEDDWDemoS3Bucket}
              - !Sub arn:aws:s3:::${HEDDWDemoS3Bucket}/*
              - !Sub arn:aws:athena:${AWS::Region}:${AWS::AccountId}:workgroup/workgroupA
          -
            Effect: Allow
            Action: athena:GetQueryExecutions
            Resource: !Sub arn:aws:athena:${AWS::Region}:${AWS::AccountId}:workgroup/workgroupA
          -
            Effect: Allow
            Action:
              - glue:Get*
              - glue:GetTable
            Resource:
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog/awsdatacatalog
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/ticketdata
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/ticketdata/parquet_sporting_event
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/ticketdata/parquet_sport_team
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/ticketdata/parquet_sport_location
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/ticketdata/sporting_event_info

  WorkgroupManagerUserPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for providing only manager access to workgroup manager user for WorkgroupA and WorkgroupB
      Path: /
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action:
              - athena:ListWorkGroups
            Resource: "*"
          -
            Effect: Allow
            Action:
              - s3:ListBucketMultipartUploads
              - s3:CreateBucket
              - s3:ListBucket
              - s3:ListMultipartUploadParts
              - s3:PutObject
              - s3:GetObject
              - s3:GetObjectAcl
              - s3:GetBucketLocation
            Resource:
              - !Sub arn:aws:s3:::${WorkgroupAS3Bucket}
              - !Sub arn:aws:s3:::${WorkgroupAS3Bucket}/*
              - !Sub arn:aws:s3:::${WorkgroupBS3Bucket}
              - !Sub arn:aws:s3:::${WorkgroupBS3Bucket}/*
              - !Sub arn:aws:s3:::${HEDDWDemoS3Bucket}
              - !Sub arn:aws:s3:::${HEDDWDemoS3Bucket}/*
              - !Sub arn:aws:athena:${AWS::Region}:${AWS::AccountId}:workgroup/workgroupA
              - !Sub arn:aws:athena:${AWS::Region}:${AWS::AccountId}:workgroup/workgroupB
          -
            Effect: Allow
            Action:
              - athena:DeleteWorkGroup
              - athena:UpdateWorkGroup
              - athena:GetWorkGroup
              - athena:CreateWorkGroup
              - athena:GetExecutionEngine
              - athena:GetExecutionEngines
              - athena:GetNamespace
              - athena:GetCatalogs
              - athena:GetNamespaces
              - athena:GetTables
              - athena:GetTable
            Resource:
              - !Sub arn:aws:athena:${AWS::Region}:${AWS::AccountId}:workgroup/workgroupA
              - !Sub arn:aws:athena:${AWS::Region}:${AWS::AccountId}:workgroup/workgroupB

  BusinessAnalystUser:
    Type: AWS::IAM::User
    Properties:
      ManagedPolicyArns:
        - !Ref BusinessAnalystUserPolicy
      LoginProfile:
        Password: Admin123!

  WorkgroupManagerUser:
    Type: AWS::IAM::User
    Properties:
      ManagedPolicyArns:
        - !Ref WorkgroupManagerUserPolicy
      LoginProfile:
        Password: Admin123!

  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns: 
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
      Policies:
        - PolicyName: LambdaRolePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: s3:DeleteObject
                Resource:
                  - !Sub arn:aws:s3:::${HEDDWDemoS3Bucket}/*
                  - !Sub arn:aws:s3:::${WorkgroupAS3Bucket}/*
                  - !Sub arn:aws:s3:::${WorkgroupBS3Bucket}/*
              - Effect: Allow
                Action: s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${HEDDWDemoS3Bucket}
                  - !Sub arn:aws:s3:::${WorkgroupAS3Bucket}
                  - !Sub arn:aws:s3:::${WorkgroupBS3Bucket}
              - Effect: Allow
                Action: logs:CreateLogGroup
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*

  S3BucketHandler:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Code:
        ZipFile: |
          import os
          import json
          import cfnresponse
          import boto3
          from botocore.exceptions import ClientError

          s3 = boto3.resource('s3')

          def handler(event, context):
              print("Received event: %s" % json.dumps(event))
              s3_bucket = s3.Bucket(event['ResourceProperties']['Bucket'])

              try:
                  if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':
                      result = cfnresponse.SUCCESS
                  elif event['RequestType'] == 'Delete':
                      s3_bucket.objects.delete()
                      result = cfnresponse.SUCCESS
              except ClientError as e:
                  print('Error: %s', e)
                  result = cfnresponse.FAILED

              cfnresponse.send(event, context, result, {})

      Runtime: python3.8
      Timeout: 300

  EmptyHEDDWDemoS3Bucket:
    Type: "Custom::EmptyS3Bucket"
    Properties:
      ServiceToken: !GetAtt S3BucketHandler.Arn
      Bucket: !Ref HEDDWDemoS3Bucket

  EmptyWorkgroupAS3Bucket:
    Type: "Custom::EmptyS3Bucket"
    Properties:
      ServiceToken: !GetAtt S3BucketHandler.Arn
      Bucket: !Ref WorkgroupAS3Bucket

  EmptyWorkgroupBS3Bucket:
    Type: "Custom::EmptyS3Bucket"
    Properties:
      ServiceToken: !GetAtt S3BucketHandler.Arn
      Bucket: !Ref WorkgroupBS3Bucket

  SisDemoDataHandler:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Code:
        ZipFile: |
          var AWS = require('aws-sdk');
          var s3 = new AWS.S3();

          exports.handler = (event) => {

              var listParams = {
                  Bucket: "ee-assets-prod-us-east-1",
                  Prefix: "modules/7009d8e656004426b1ea6f27f0487d56/v1/sisdemo/"
              };

              s3.listObjectsV2(listParams, function(err, data) {
                  if (err) console.log(err, err.stack); // an error occurred
                  else {
                      if (data.Contents.length) {
                          data.Contents.forEach(file => {
                              console.log(file);
                              var copyParams = {
                                  Bucket: process.env.BUCKET,
                                  CopySource: "ee-assets-prod-us-east-1" + '/' + file.Key,
                                  Key: file.Key.replace("modules/7009d8e656004426b1ea6f27f0487d56/v1/sisdemo/", "sisdemo/")
                              };
                              console.log(copyParams);
                              s3.copyObject(copyParams, function(copyErr, copyData) {
                                  if (copyErr) {
                                      console.log(copyErr);
                                  }
                                  else {
                                      console.log('Copied: ', copyParams.Key);
                                  }
                              });
                          });
                      }
                  }
              });
          };
          
      Environment: 
        Variables:
          BUCKET: !Ref HEDDWDemoS3Bucket
      Runtime: nodejs14.x
      Timeout: 300

  dataeduSSMParam6F974C31:
    Type: 'AWS::SSM::Parameter'
    Properties:
      Type: String
      Value:
        'Fn::Join':
          - ''
          - - '{"base_url":"ee-assets-prod-'
            - Ref: 'AWS::Region'
            - >-
              .s3.amazonaws.com/modules/cfdd4f678e99415a9c1f11342a3a9887/v1/mockdata/lms_demo","version":
              "v1", "current_date": "2020-08-17", "perform_initial_load":
              "1","target_bucket":"
            - Ref: HEDDWDemoS3Bucket
            - '", "base_s3_prefix":"lmsapi"}'
      Description: SSM Parameter for mock LMS integration.
      Name: /dataedu/lms-demo/state

  dataeduLMSS3FetchRole16948341:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
      RoleName: dataedu-fetch-s3-lambda-role

  dataeduLMSS3FetchRoleDefaultPolicyE0083EF5:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - HEDDWDemoS3Bucket
                - Arn
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
              - 's3:DeleteObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - HEDDWDemoS3Bucket
                      - Arn
                  - /*
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
        Version: '2012-10-17'
      PolicyName: dataeduLMSS3FetchRoleDefaultPolicyE0083EF5
      Roles:
        - Ref: dataeduLMSS3FetchRole16948341

  dataeduLMSS3FetchLambdaB561DBA8:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket:
          'Fn::Join':
            - ''
            - - ee-assets-prod-
              - Ref: 'AWS::Region'
        S3Key: >-
          modules/cfdd4f678e99415a9c1f11342a3a9887/v1/lambda/dataedu-fetch-s3-data.zip
      Role:
        'Fn::GetAtt':
          - dataeduLMSS3FetchRole16948341
          - Arn
      Description: >-
        Lambda function that fetches a file from a URL and stores it in a S3
        bucket
      FunctionName: dataedu-fetch-s3-data
      Handler: lambda_handler.lambda_handler
      MemorySize: 256
      Runtime: python3.7
      Timeout: 600
    DependsOn:
      - dataeduLMSS3FetchRoleDefaultPolicyE0083EF5
      - dataeduLMSS3FetchRole16948341

  dataeduLMSAPIFetchRoleE153F61C:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
      RoleName: dataedu-fetch-s3-data-role

  dataeduLMSAPIFetchRoleDefaultPolicy716C3933:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ssm:PutParameter'
              - 'ssm:GetParameter'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ssm:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':parameter'
                  - Ref: dataeduSSMParam6F974C31
          - Action:
              - 'lambda:InvokeFunction'
              - 'lambda:InvokeAsync'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:aws:lambda:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':function:dataedu-*'
          - Action: 'events:DisableRule'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:aws:events:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':rule/dataedu-lmsapi-sync'
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
        Version: '2012-10-17'
      PolicyName: dataeduLMSAPIFetchRoleDefaultPolicy716C3933
      Roles:
        - Ref: dataeduLMSAPIFetchRoleE153F61C

  dataeduLMSAPIFetchLambdaBD421AD7:
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket:
          'Fn::Join':
            - ''
            - - ee-assets-prod-
              - Ref: 'AWS::Region'
        S3Key: >-
          modules/cfdd4f678e99415a9c1f11342a3a9887/v1/lambda/dataedu-fetch-lmsapi.zip
      Role:
        'Fn::GetAtt':
          - dataeduLMSAPIFetchRoleE153F61C
          - Arn
      Description: >-
        Lambda function that mimics invoking an API to obtain data from a SaaS
        app
      FunctionName: dataedu-fetch-lmsapi
      Handler: lambda_function.lambda_handler
      MemorySize: 256
      Runtime: python3.7
      Timeout: 600
    DependsOn:
      - dataeduLMSAPIFetchRoleDefaultPolicy716C3933
      - dataeduLMSAPIFetchRoleE153F61C

  dataeduEventBridgeRuleF5498C76:
    Type: 'AWS::Events::Rule'
    Properties:
      Description: Invokes demo API on a scheduled basis
      Name: dataedu-lmsapi-sync
      ScheduleExpression: rate(1 minute)
      State: DISABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - dataeduLMSAPIFetchLambdaBD421AD7
              - Arn
          Id: Target0

  dataeduEventBridgeRuleAllowEventRuledataEDUstackEEdataeduLMSAPIFetchLambda7A54F1DB5834D1AF:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - dataeduLMSAPIFetchLambdaBD421AD7
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        'Fn::GetAtt':
          - dataeduEventBridgeRuleF5498C76
          - Arn

  RedshiftSpectrumRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - redshift.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        -
          PolicyName: RedshiftPolicyForLF
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              -
                Sid: Lakeformation
                Effect: Allow
                Action:
                  - glue:*
                  - lakeformation:GetDataAccess
                Resource: "*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess

  RedshiftCluster: 
    Type: "AWS::Redshift::Cluster"
    Properties:
      DBName: "ra3db"
      IamRoles:
        - !GetAtt RedshiftSpectrumRole.Arn
      MasterUsername: "ra3admin"
      MasterUserPassword: "iamRa3admin1!"
      NodeType: "ra3.xlplus"
      ClusterType: "single-node"

Outputs:
  GlueLabRole:
    Description: The Glue service role
    Value: !Ref GlueLabRole

  LakeFormationRole:
    Description: Lake Formation IAM role
    Value: !Ref LakeFormationWorkflowRole

  HEDDWDemoS3Bucket:
    Description: S3 Bucket that was created
    Value: !Ref HEDDWDemoS3Bucket

  WorkgroupAS3Bucket:
    Description: S3 Bucket for storing workgroup A results
    Value: !Ref WorkgroupAS3Bucket

  WorkgroupBS3Bucket:
    Description: S3 bucket for storing workgroup B results
    Value: !Ref WorkgroupBS3Bucket

  BusinessAnalystUser:
    Description: business_analyst_user for Workgroup A
    Value: !Ref BusinessAnalystUser

  WorkgroupManagerUser:
    Description: workgroup_manager_user for access to Workgroup A and Workgroup B
    Value: !Ref WorkgroupManagerUser
